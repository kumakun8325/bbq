# 🏗️ 設計ドキュメント

> **Project**: BBQ (Bird Battle Quest)  
> **Version**: 0.1.0  
> **Last Updated**: 2025-12-15

---

## 1. アーキテクチャ概要

### 1.1 システム構成

```
┌─────────────────────────────────────────────────────────────┐
│                        Game (Phaser)                        │
├─────────────────────────────────────────────────────────────┤
│  Scenes                                                      │
│  ┌─────────┐ ┌──────────┐ ┌─────────┐ ┌──────────────────┐ │
│  │  Boot   │→│ Preload  │→│  Title  │→│      Map         │ │
│  └─────────┘ └──────────┘ └─────────┘ └────────┬─────────┘ │
│                                                 │            │
│                                     ┌───────────▼─────────┐ │
│                                     │      Battle         │ │
│                                     └─────────────────────┘ │
├─────────────────────────────────────────────────────────────┤
│  Systems                                                     │
│  ┌──────────┐ ┌──────────┐ ┌──────────┐ ┌──────────┐       │
│  │   Map    │ │  Battle  │ │   Save   │ │   UI     │       │
│  │  System  │ │  System  │ │  System  │ │  System  │       │
│  └──────────┘ └──────────┘ └──────────┘ └──────────┘       │
├─────────────────────────────────────────────────────────────┤
│  Entities                                                    │
│  ┌──────────┐ ┌──────────┐ ┌──────────┐ ┌──────────┐       │
│  │  Player  │ │   Enemy  │ │   Item   │ │   NPC    │       │
│  └──────────┘ └──────────┘ └──────────┘ └──────────┘       │
├─────────────────────────────────────────────────────────────┤
│  Data Layer                                                  │
│  ┌──────────────────────┐ ┌────────────────────────────┐    │
│  │  Game State Manager  │ │  LocalStorage (Save Data)  │    │
│  └──────────────────────┘ └────────────────────────────┘    │
└─────────────────────────────────────────────────────────────┘
```

### 1.2 設計原則

| 原則 | 説明 |
|------|------|
| **単一責任 (SRP)** | 各シーン/システムは1つの責任のみを持つ |
| **疎結合** | シーン間はデータ受け渡しで連携 |
| **ドキュメント駆動** | 仕様書とコードを同期 |
| **FF6参照駆動** | UIやゲームデザインはFF6を参考にする |
| **言語方針** | 思考・設計・実装ログは**英語**、最終的なユーザー報告は**日本語**で行う |
| **設計第一** | いきなり実装せず、必ず設計書（`design.md`等）を作成・更新してから実装へ進む |
| **コード整形** | Tyepscriptは `Prettier` を使用して整形する（拡張機能または `npx prettier --write` コマンド） |

#### 🎮 FF6参考画像ルール
*   バトルシステムのUIや挙動は、SFC版FF6（特に以下の動画）をリファレンスとする
    *   参考動画: [FF6 究極兵器 アルテマウェポン戦](https://www.youtube.com/watch?v=CrKhh4kJmt0)

> **重要**: FF6風のUI/UX実装時は、以下の方法で参考画像を取得すること。
> 
> 1. **ユーザーに提供依頼** - 必要に応じてFF6の参考画像を依頼
> 2. **インターネット検索** - 必要に応じてWeb検索で参考画像を収集
> 
> 参考対象:
> - バトル画面レイアウト
> - メニュー画面デザイン
> - エフェクト・アニメーション
> - キャラクタースプライト比率
> 
> 参考画像を元に正確な再現を行う。

#### 🔧 リファクタリングルール

> **重要**: 基本機能の開発が完了したら、以下の手順でリファクタリングを実施すること。
> 
> 1. コードの整理・最適化
> 2. 重複コードの削除
> 3. 命名規則の統一
> 4. テストの実施（ユーザー確認不要、全て自動実行）
> 
> テストはユーザーに確認を求めず、全て実施する。

#### 🔍 GitHub検索ルール（車輪の再発明防止）

> **重要**: 新機能の実装を開始する前に、以下の手順でGitHubを検索すること。
> 
> **検索タイミング**
> 1. 新しいシステム/機能の実装開始前
> 2. 複雑なアルゴリズムや仕組みを実装する前
> 3. 外部ライブラリの導入を検討する前
> 
> **検索対象**
> - ATBバトルシステム実装
> - ブレイク/シールドシステム
> - Phaserプラグイン
> - ピクセルアートジェネレーター
> - タイルマップシステム
> 
> **検索キーワード例**
> ```
> "phaser atb battle system"
> "phaser rpg combat"
> "octopath traveler break system javascript"
> "pixel art generator typescript"
> ```
> 
> **評価基準**
> | 項目 | 確認内容 |
> |------|---------|
> | ライセンス | MIT, Apache 2.0 等の利用可能なライセンスか |
> | 更新頻度 | 最終更新が1年以内か、活発にメンテされているか |
> | スター数 | 一定の評価を得ているか（目安: 50+） |
> | 依存関係 | 本プロジェクトと互換性があるか |
> | コード品質 | TypeScript対応、テストの有無 |
> 
> **活用フロー**
> ```
> 1. GitHub検索で候補を特定
> 2. README/ドキュメントを確認
> 3. ライセンスを確認
> 4. サンプルコードを試す
> 5. 利用可能であれば導入、不可であれば参考にして実装
> ```
> 
> **結果の記録**
> - 検索した内容と結果をコミットメッセージまたはドキュメントに記録
> - 採用した場合はCHANGELOG.mdに依存関係として記載

### 1.3 Git/ブランチ戦略

> ⚠️ **重要**: 機能開発を開始する前に、必ずフィーチャーブランチを作成すること。

#### ブランチ命名規則

```
feature/<機能名>     # 新機能開発
bugfix/<バグ名>      # バグ修正
refactor/<対象>      # リファクタリング
docs/<ドキュメント名>  # ドキュメント更新
```

#### ワークフロー

```
main (安定版)
  ↓
  ├── feature/xxx ← 開発
  │     ↓
  │   PR/マージ → main
  │
  ├── feature/yyy ← 並行開発
  ...
```

#### フィーチャーブランチ対応表

| ブランチ名 | 機能 | 状態 |
|-----------|------|------|
| `feature/tilemap-system` | Tiledマップシステム | ✅ マージ済 |
| `feature/player-sprite` | 歩行アニメーション付きプレイヤースプライト | ✅ マージ済 |
| `feature/battle-improvements` | バトルUI改善、ダメージポップアップ | ✅ マージ済 |
| `feature/enemy-sprites` | 敵スプライト作成（スライム/コウモリ/ゴブリン） | ✅ マージ済 |
| `feature/shield-break` | オクトパストラベラー風シールド/ブレイクシステム | ✅ マージ済 |
| `feature/party-system` | パーティシステム | ✅ マージ済 |
| `feature/save-load` | セーブ/ロード機能 | ⬜ 未着手 |

### 1.4 テスト運用方針

リアルタイム性が高く、AIによる自動検証が困難な機能（ATBバトルシステムの挙動など）については、以下の分担で品質保証を行う。

- **開発者（AI）**:
  - 実装およびビルド確認（`npm run build`）
  - 静止画（スクリーンショット）によるUI/初期状態/結果の確認
  - 単純なシーケンスの自動テスト（可能な範囲で）
  - TypeScriptの型エラー・構文エラーの修正
- **ユーザー**:
  - **開発サーバー（`npm run dev`）での動作確認**
  - リアルタイム挙動の結合テスト
  - ゲームバランスや操作感の確認
  - バグ報告と再現手順の提供

> ⚠️ **重要**: 開発サーバーでのブラウザテストは**ユーザーに依頼**すること。
> AIはビルド成功を確認した後、「開発サーバーを起動しました。動作確認をお願いします」とユーザーに報告する。

---

## 2. モジュール設計

### 2.1 ディレクトリ構造

```
bbq/
├── src/
│   ├── main.ts                 # エントリーポイント
│   ├── config/
│   │   ├── gameConfig.ts       # Phaser設定
│   │   └── battleConfig.ts     # バトルシステム定数（ATB、UI、レイアウト）
│   ├── scenes/
│   │   ├── BootScene.ts        # 初期化シーン
│   │   ├── PreloadScene.ts     # アセットロード
│   │   ├── TitleScene.ts       # タイトル画面
│   │   ├── MapScene.ts         # フィールドマップ
│   │   ├── BattleScene.ts      # バトル画面
│   │   └── index.ts            # シーンエクスポート
│   ├── systems/
│   │   ├── DamageCalculator.ts # ダメージ計算ロジック
│   │   └── BattleUtils.ts      # 弱点アイコン等のユーティリティ
│   ├── managers/
│   │   └── GameStateManager.ts # ゲーム全体の状態管理
│   ├── ui/
│   │   └── BattleUIHelpers.ts  # UI描画ヘルパー（ウィンドウ、HPバー、ATBゲージ）
│   ├── data/
│   │   ├── enemies.ts          # 敵データベース
│   │   ├── characters.ts       # キャラクターデータ
│   │   ├── abilities.ts        # アビリティ定義
│   │   └── items.ts            # アイテム定義
│   └── types/
│       └── index.ts            # 型定義
├── assets/
│   ├── images/
│   ├── audio/
│   └── maps/
├── public/
│   └── favicon.ico
├── .kiro/steering/             # SDD ドキュメント
├── docs/                       # 追加ドキュメント
└── .agent/workflows/           # AIワークフロー
```

### 2.2 モジュール一覧

| モジュール | 役割 | 依存先 |
|------------|------|--------|
| BootScene | 最小アセットロード | なし |
| PreloadScene | メインアセットロード | BootScene |
| TitleScene | タイトル表示、ゲーム開始 | PreloadScene |
| MapScene | フィールド移動、エンカウント | TitleScene |
| BattleScene | ターン制バトル | MapScene |

### 2.3 シーン間データフロー

```
TitleScene
    │
    │ scene.start('MapScene')
    ▼
MapScene ──────────────────────────────────────┐
    │                                          │
    │ エンカウント発生                          │
    │ scene.start('BattleScene', {             │
    │   enemyType: 'slime',                    │
    │   returnScene: 'MapScene',               │
    │   playerPosition: { x, y }               │
    │ })                                       │
    ▼                                          │
BattleScene                                    │
    │                                          │
    │ 勝利/逃走                                 │
    │ scene.start('MapScene', {                │
    │   playerPosition: { x, y }               │
    │ })                                       │
    └──────────────────────────────────────────┘
```

---

## 3. データ設計

### 3.1 主要データ構造

```typescript
// キャラクターステータス
export interface CharacterStats {
  hp: number;
  maxHp: number;
  mp: number;
  maxMp: number;
  attack: number;
  defense: number;
  speed: number;
  level: number;
  exp: number;
}

// キャラクター定義（不変データ）
export interface CharacterDefinition {
  id: string;
  name: string;
  initialStats: CharacterStats;
  spriteKey: string;
  defaultWeapon: WeaknessType;
}

// キャラクターインスタンス（可変データ）
export interface CharacterInstance extends CharacterDefinition {
  currentStats: CharacterStats; // 現在の能力値（装備補正込み）
  currentHp: number;
  currentMp: number;
  isDead: boolean;
  // 将来的には装備、状態異常などもここへ
}

// 敵データ
export interface EnemyData {
  id: string;
  name: string;
  stats: CharacterStats;
  weakness: ElementType[];     // 弱点属性
  shieldPoints: number;        // シールド値
  drops: ItemDrop[];
  expReward: number;
  goldReward: number;
}

// オクトパストラベラー風バトルシステム用
export interface BreakableEnemy extends EnemyData {
  shield: number;              // 現在のシールド
  maxShield: number;           // 最大シールド
  isBroken: boolean;           // ブレイク状態
  weaknesses: string[];        // 弱点リスト
}

```

### 3.2 永続化データ (LocalStorage)

| キー | 用途 | 形式 |
|------|------|------|
| `bbq_savedata` | セーブデータ | JSON |
| `bbq_settings` | 設定（音量等） | JSON |

### 3.3 セーブデータ構造

```typescript
interface SaveData {
  version: string;
  timestamp: number;
  party: PartyMember[];
  inventory: InventoryItem[];
  progress: {
    currentMap: string;
    position: { x: number; y: number };
    flags: Record<string, boolean>;
  };
  playtime: number;
}
```

---

## 3.5 FF6風ATBバトルシステム仕様

> **参考**: Final Fantasy VI Active Time Battle (ATB) System

### 3.5.1 ATBゲージ基本仕様

| 項目 | 仕様 |
|------|------|
| ゲージ表示 | パーティメンバーのみ表示（敵は非表示） |
| ゲージ最大値 | 100 |
| 行動可能条件 | ATBゲージが100に到達 |
| 行動後 | ATBゲージが0にリセット |

### 3.5.2 ATBゲージ回復速度

```typescript
// ATBゲージ回復式
atbRecoveryPerFrame = (baseSpeed + characterSpeed) * speedModifier;

// 例：baseSpeed = 0.3, characterSpeed = 10, speedModifier = 1.0
// → 1フレームあたり約0.4回復 → 約250フレーム（4秒程度）で満タン
```

#### スピードステータスの影響

| スピード値 | 回復速度 | 満タンまでの時間（目安） |
|-----------|---------|----------------------|
| 10（低速） | 0.4/frame | 約4秒 |
| 50（標準） | 0.8/frame | 約2秒 |
| 100（高速） | 1.3/frame | 約1.3秒 |

### 3.5.3 ステータス効果とATB

| ステータス | ATBへの影響 |
|-----------|------------|
| **ヘイスト** | 回復速度1.5倍 |
| **スロウ** | 回復速度0.5倍 |
| **ストップ** | ATB回復停止 |
| **戦闘不能(KO)** | ATBが0にリセット、回復停止 |
| **石化** | ATB回復停止 |
| **睡眠** | ATB回復停止 |

### 3.5.3b バフ・デバフの累積ルール（将来実装参考）

> 参考: `docs/オクトパストラベラー戦闘メカニクス詳細解析.md`

#### 効果時間の累積（Stacking）

| 項目 | 仕様 |
|------|------|
| **累積方式** | 同種バフをかけ直すと効果時間が**加算**される（上書きではない） |
| **最大ターン数** | 9ターンでカンスト |
| **例** | 残り2ターン + 追加2ターン = 合計4ターン |

#### ブーストによる持続時間延長

バフ・デバフスキルにBPを使用すると**効果時間**が延長される（効果量は変わらない）

```
持続ターン = 基本ターン数 + (ブーストLv × 2)

例: 基本2ターンのバフ
- ブーストなし: 2ターン
- Lv.1: 4ターン
- Lv.2: 6ターン
- MAX: 8ターン
```

#### バフ・デバフの相殺

| 状況 | 挙動 |
|------|------|
| 相反効果の付与 | 互いに打ち消し合う（Offset） |
| 例 | 「攻撃ダウン」状態に「攻撃アップ」使用 → ニュートラル状態に戻る |
| 戦術的活用 | デバフ解除手段としてバフスキルが有用 |


### 3.5.4 バトルモード

| モード | 説明 |
|-------|------|
| **アクティブ** | メニュー操作中もATBが進行。敵も攻撃してくる |
| **ウェイト** | メニュー操作中はATBが停止。戦略的な選択が可能 |

> MVP実装では**ウェイトモード**のみサポート

### 3.5.5 エンカウント種類とATB初期値

| エンカウント | パーティATB | 敵ATB | 特徴 |
|-------------|-----------|-------|------|
| **通常** | ランダム(30-70) | ランダム(30-70) | 標準的なエンカウント |
| **先制攻撃** | 100（満タン） | 0 | プレイヤー有利 |
| **バックアタック** | 0 | 100（満タン） | 敵有利、背後から攻撃 |
| **挟み撃ち** | 0 | ランダム | 敵に囲まれる |
| **サイドアタック** | 100（満タン） | 0 | プレイヤーが敵を囲む |

### 3.5.6 アクションチャージタイム

```
[ATB満タン] → [コマンド選択] → [チャージタイム] → [アクション実行]
```

| アクション | チャージタイム（フレーム） |
|-----------|----------------------|
| たたかう | 10 |
| まほう | 20-40（魔法による） |
| アイテム | 15 |
| ぼうぎょ | 0（即時） |
| にげる | 30 |

### 3.5.7 バトル画面レイアウト (SFC FF6スタイル: アルテマウェポン戦準拠)

```
┌─────────────────────────────────────────────────────────────┐
│                        バトル背景                           │
│                                                             │
│         [敵キャラ]                                           │
│       （アルテマウェポン）            [パーティ4人]          │
│                                       縦一列配置             │
│   [コマンドPOPUP]                       キャラ1（手前）      │
│   ┌───────────┐                         キャラ2              │
│   │☛たたかう  │                         キャラ3              │
│   │  とくぎ   │                         キャラ4（奥）        │
│   │  アイテム │                                              │
│   └───────────┘                                              │
├────────────────────┬────────────────────────────────────────┤
│ ┌────────────────┐ │ ┌────────────────────────────────────┐ │
│ │ 敵名ウィンドウ │ │ │ パーティステータスウィンドウ       │ │
│ │                │ │ │                                    │ │
│ │ アルテマウェポン│ │ │ キャラ1  100/ 100  [二二二二二]  │ │
│ │                │ │ │ キャラ2   80/  80  [二二二    ]  │ │
│ └────────────────┘ │ │ キャラ3   90/  90  [二二二二  ]  │ │
│                    │ │ キャラ4  120/ 120  [二二      ]  │ │
│                    │ └────────────────────────────────────┘ │
└────────────────────┴────────────────────────────────────────┘
```

*   **下部レイアウト**:
    *   **左ウィンドウ**: 敵名を表示。コマンド選択時は、このウィンドウの上に**ポップアップ**する形でコマンドメニューが表示される。
    *   **右ウィンドウ**: パーティ全員のステータス（名前、HP、ATBゲージ）を表示。
*   **ATBゲージ**:
    *   デザイン: 濃いグレーの背景に明るいグレーの枠。
    *   色: 溜め中は白/薄いグレー、満タン時は黄色/オレンジ系に発光。
    *   配置: HP等の文字と重ならないように右側にオフセット。

<!-- Old Layout Removed -->

```
┌─────────────────────────────────────────────────────────────┐
│                        バトル背景                           │
│                                                             │
│    [敵スプライト]              [パーティ4人]                 │
│        左側                    右側（斜め配置）              │
│                                                             │
│                                キャラ1（手前）               │
│                                  キャラ2                     │
│                                    キャラ3                   │
│                                      キャラ4（奥）           │
├─────────────────────────────────────────────────────────────┤
│ ┌──────────┐ ┌─────────────────────────────────────────────┐│
│ │ 敵名     │ │ キャラ名    HP     ATBゲージ               ││
│ ├──────────┤ │ とりくん    100    ████████████████████░░░ ││
│ │▶たたかう │ │ だいちゃん   80    ██████████████░░░░░░░░░ ││
│ │ ぼうぎょ │ │ しんいち    90    █████████░░░░░░░░░░░░░░ ││
│ │ にげる   │ │ たいさ     120    ███████░░░░░░░░░░░░░░░░ ││
│ └──────────┘ └─────────────────────────────────────────────┘│
└─────────────────────────────────────────────────────────────┘
```

### 3.5.8 パーティメンバー深度（重なり順）

| メンバー | 位置 | 深度 | 表示順 |
|---------|------|------|-------|
| 1人目 | 右上 | 100（最高） | 最前面 |
| 2人目 | ↓左下 | 90 | ↓ |
| 3人目 | ↓左下 | 80 | ↓ |
| 4人目 | 左下 | 70（最低） | 最背面 |

> **注意**: Phaserでは`setDepth(n)`の値が大きいほど手前に表示される

### 3.5.9 MVP実装範囲

| 機能 | MVP対応 | 備考 |
|------|---------|------|
| ATBゲージ表示 | ✅ | パーティ4人分（敵は内部計算） |
| ATB回復 | ✅ | `(base + speed/100)`で計算 |
| 攻撃でATBリセット | ✅ | 0にリセット |
| ウェイトモード | ✅ | メニュー中・演出中は停止 |
| 敵ATBシステム | ✅ | 敵もATBでターン管理 |
| ランダムターゲット | ✅ | 敵は生存者をランダム攻撃 |
| ATB満タン順行動 | ✅ | ATBが先に満タンになったキャラから行動 |
| ターン管理 | ✅ | 全員が1回ずつ行動したら次のターンへ |
| HP/MP表示 | ✅ | 「現在値/最大値」形式 |
| 固有スキル | ✅ | 各キャラ固有技（ぜんりょく、たたきわる、いのる等） |
| HP/MP持ち越し | ✅ | 戦闘間でHP/MPを保持 |
| アクティブモード | ⬜ | 将来実装 |
| ステータス効果 | ⬜ | 将来実装 |
| エンカウント種類 | ⬜ | 将来実装（現在はランダム初期値のみ） |
| チャージタイム | ⬜ | 将来実装 |
| 防御による先制権 | ⬜ | 将来実装（オクトラ参照） |

### 3.5.9b 行動順制御システム（将来実装参考）

> 参考: `docs/オクトパストラベラー戦闘メカニクス詳細解析.md`

#### 防御（Defend）コマンドの戦略的価値

| 項目 | 仕様 |
|------|------|
| **次ターン先制権** | 防御を選択したキャラは次ターンで**最速行動権**を得る |
| 複数防御時 | 防御したキャラ間で素早さ判定 |
| BP温存効果 | 防御中はBP使用不可 → 次ターン開始時にBP回復 + 先行フルブースト攻撃可能 |

#### 戦術的活用例

1. **ブレイク先行入力**: 敵の強力攻撃チャージ中に今ターン防御 → 次ターン最初に総攻撃でブレイク、攻撃キャンセル
2. **緊急回復**: 瀕死の味方がいる場合、ヒーラーが防御して次ターンの敵行動前に確実回復
3. **溜め行動**: 防御で1ターン耐えつつ、次ターンの優位を確保

#### 行動順の乱数幅（参考値）

| 項目 | 仕様 |
|------|------|
| 乱数係数 | 0.8 ～ 1.2（±20%）程度 |
| 設計意図 | 完全な固定順を避け、「もし敵に先制されたら」のリスク管理を強制 |
| 低速キャラ救済 | 運次第で先手を取れるチャンスを残す |


### 3.5.10 実装上の注意点

1. **深度問題**: スプライトの重なり順はPhaserの`setDepth()`で制御。大きな値（100単位）で差をつけること
2. **ATBバー幅**: 固定幅（80px）で描画し、超過しないよう`Math.min()`でクランプ
3. **パフォーマンス**: `update()`での毎フレーム処理は最小限に抑える
4. **UI座標**: ハードコーディングせず、定数化して管理する

### 3.5.11 FF6オリジナルATB計算式（参考）

> 以下は将来の高度な実装時の参考情報。MVPでは簡略化した式を使用。

#### ATBゲージ内部管理

| 項目 | FF6オリジナル仕様 |
|------|------------------|
| ゲージ最大値 | 65536（16ビット） |
| 更新頻度 | 約30回/秒（1ティック≈0.033秒） |
| オーバーフロー注意 | 素早さ+20 が255を超えると異常動作 |

#### ATBゲージ増加量計算式

```typescript
// FF6オリジナル計算式（参考）
// プレイヤーキャラの場合:
ATB増加量_通常   = (96  * (素早さ + 20)) / 16;
ATB増加量_ヘイスト = (126 * (素早さ + 20)) / 16; // 約+31%
ATB増加量_スロウ  = (48  * (素早さ + 20)) / 16;  // 約50%

// 敵キャラの場合（バトルスピード設定が影響）:
ATB増加量 = ((96 * (素早さ + 20)) * (255 - (BatSpeed-1)*24)) / 16;
// BatSpeed: 1=速い, 2=標準, 3=遅い
```

> **注意**: SNES/PS版ではバトルスピードは敵のみに影響。Pixel Remaster版では味方にも影響する。

### 3.5.12 ダメージ計算式（FF6準拠・参考）

> 将来的なダメージ計算の拡張時に参照。

#### 物理ダメージ

```typescript
// ステップ1: 基本ダメージ
BaseDamage = BattlePower + (Level² × BattlePower × Vigor / 256) × 1.5;

// ステップ2: 倍率補正
FinalDamage = BaseDamage × Random(224, 255) / 256 × Modifiers;

// 主なModifiers:
// - クリティカル: 2.0倍
// - バーサク: 1.5倍
// - 後列: 0.5倍
// - 防御中: 0.5倍
// - アトラスの腕輪: 1.25倍（装備による補正）
// - 防御力軽減: × (255 - Defense) / 256
```

#### 魔法ダメージ

```typescript
// 基本魔法ダメージ
BaseMagicDamage = SpellPower + (Level² × MagicPower × SpellPower / 256) × 1.5;

// 補正:
// - 全体化: ダメージ × 0.5
// - シェル状態: ダメージ × 0.66
```

### 3.5.13 命中・回避システム（参考）

| 項目 | 仕様 |
|------|------|
| 命中率計算 | `HitChance(%) = BaseHitRate + AttackerStats - TargetEvasion` |
| 物理回避 | 物理攻撃に対する回避率 |
| 魔法回避 | 魔法攻撃に対する回避率 |
| 必中条件 | 睡眠/石化/ストップ/麻痺状態の対象、または回避無視攻撃 |

> **SFC版の有名なバグ**: 物理回避率ステータスが機能せず、全ての回避に魔法回避率(MBlock%)が使用されていた。GBA/Pixel Remaster版で修正済み。

### 3.5.14 特殊システム（将来実装候補）

#### 瀕死必殺技（Desperation Attacks）

| 項目 | 仕様 |
|------|------|
| 発動条件 | HP < MaxHP / 8 |
| 発動確率 | 約6.25%（1/16） |
| 発動タイミング | 「たたかう」選択時に判定 |

#### 連続攻撃

| 技 | 効果 |
|-----|------|
| **二刀流** | 右手→左手の順に攻撃。各武器で個別にダメージ計算 |
| **みだれうち** | 4回連続攻撃、1発あたり0.5倍ダメージ、ターゲットランダム |

#### 順番送り（パス）

FF6では行動順を遅らせて他キャラを先に行動させる「順番送り」が可能（Xボタンで前送り、Yボタンで後送り）。

#### 召喚魔法の時間停止

通常の魔法・技の発動中もATBは進行するが、**召喚魔法の発動演出中のみ時間が停止**する。
これは召喚発動時にターゲット指定が行えないため、ゲージ停止が必須の仕様である。

#### 確定行動スキップ（バグ/テクニック）

敵のATBゲージが満タン状態で味方のカウンターを発動させると、**敵のATBゲージが0にリセット**される不具合がある。
ボス戦で特定の攻撃をキャンセルするテクニックとして利用可能。

#### ウィンドウ調整テクニック

ウェイトモードで味方行動時にメニューを開き、敵行動時に閉じることで、
**敵のターンをほぼ無駄にできる**戦術が可能（FF6以降の特徴）。

#### 技術的注意: 素早さオーバーフロー

`素早さ + 20` は1バイト（0～255）に収まる必要がある。
**素早さが235を超えるとオーバーフロー**してATBゲージが極端に遅くなるバグがある。

### 3.5.15 詳細仕様リファレンス

> 詳細な調査結果は以下のドキュメントを参照：
> - `docs/FF6のATBバトルシステム – 詳細仕様.md`
> - `docs/FF6 ATBバトルシステム仕様調査報告書.md`

---

## 3.6 オクトパストラベラー風ブレイクシステム仕様

> **参考**: Octopath Traveler Break Shield System
> 
> 詳細な調査結果は以下のドキュメントを参照：
> - `docs/『オクトパストラベラー』（2018）バトルシステム概要.md`
> - `docs/オクトパストラベラー戦闘メカニクス詳細解析.md`

### 3.6.1 基本概念

敵には「シールドポイント」と「弱点」が設定されており、弱点を突くことでシールドを削り、0になると「ブレイク状態」になる。

```
[敵シールド: 5] → [弱点攻撃×5回] → [ブレイク！] → [2倍ダメージ＆行動不能]
```

### 3.6.2 シールドポイント

| 項目 | 仕様 |
|------|------|
| 表示 | 敵の下に青いシールドアイコン + 数字 |
| 範囲 | 1〜10（敵の強さによる） |
| 削減条件 | 弱点属性/武器で攻撃 |
| 削減量 | 1ヒットにつき1（マルチヒットで複数削減可能） |
| ブレイク条件 | シールドポイントが0になる |
| 回復 | ブレイク解除後、最大値に戻る |

### 3.6.3 弱点システム

#### 弱点の種類

| カテゴリ | 種類 |
|---------|------|
| **武器** | 剣、槍、短剣、斧、弓、杖、本、扇 |
| **属性** | 火、氷、雷、風、光、闇 |

> MVP実装では簡略化: **剣、弓、魔法（火/氷/雷）**のみ

#### 弱点の表示

```
敵名: ゴブリン
シールド: ●●●●● (5)
弱点: [剣] [?] [?] [火] [?]
       ↑発見済   ↑未発見
```

#### 弱点の発見方法

| 方法 | 説明 |
|------|------|
| **試行錯誤** | 弱点属性で攻撃すると発見＆シールド削減 |
| **分析スキル** | 「みやぶる」で弱点1つを発見（SP消費） |
| **戦闘開始時** | 一部キャラは自動で弱点1つを発見 |

#### 弱点ダメージボーナス

| 状態 | ダメージ倍率 |
|------|------------|
| 弱点でない攻撃 | 1.0x（等倍） |
| 弱点攻撃 | 1.3x（30%増加） |
| ブレイク中の攻撃 | 2.0x（2倍） |
| ブレイク中＋弱点 | 2.0x（弱点ボーナスは適用されない） |

### 3.6.4 ブレイク状態

| 項目 | 仕様 |
|------|------|
| 発動条件 | シールドポイントが0になる |
| 効果1 | 敵は次のターンまで行動不能（スタン） |
| 効果2 | 受けるダメージが2倍 |
| 効果3 | クリティカル率が大幅上昇（または確定） |
| 持続時間 | **[実装済]** ブレイクしたターン + 2ターン後に回復（最低1回は完全に行動スキップ） |
| 解除後 | シールドポイントが最大値に回復 |

#### ブレイクタイミングによる有利不利

| タイミング | 効果 |
|-----------|------|
| **ターン前半で発動** | 敵の行動をキャンセル + 次ターンも行動不能（約2ターン分のチャンス） |
| **ターン後半で発動** | キャンセルされるのは次ターンのみ（約1ターン分） |

> **戦術の含意**: 素早さを調整して敵の行動前にブレイクを狙うか、  
> あえて敵に行動させてからブレイクし次ターンの安全を確保するかの選択

#### ブレイク時のビジュアル演出

```
1. シールドが砕けるエフェクト
2. 敵が揺れる＆色が暗くなる
3. 「BREAK!」のテキスト表示
4. 敵の頭上に「ピヨり星（★）」アニメーション表示
5. 回復時に「体勢を立て直した！」メッセージ表示
```

#### ブレイク回復後の脅威

| 項目 | 仕様 |
|------|------|
| 復帰タイミング | 次のターン開始時に即座に行動順判定に参加 |
| ボス特性 | 復帰直後に強力な攻撃を行う傾向あり |
| シールド変動 | 一部ボスは復帰ごとにシールド最大値が増加 |
| 弱点変更 | 一部ボスは復帰時に弱点を変更・ロックする |

> **設計意図**: 戦闘が長期化するほどブレイクの難易度が上がり、  
> プレイヤーに火力向上の工夫を促す動的な難易度調整


### 3.6.5 ブーストポイント（BP）システム

> オプション: MVP後に実装検討
> 参考: `docs/オクトパストラベラー戦闘メカニクス詳細解析.md`

#### 基本仕様

| 項目 | 仕様 |
|------|------|
| 初期BP | 戦闘開始時 1 BP（パッシブスキルで増加可能） |
| 最大蓄積 | 5 BP |
| ターン回復 | 毎ターン開始時に +1 BP |
| 1回の消費上限 | 最大 3 BP（5 BP持っていても一度に全消費は不可） |
| **ブースト後ペナルティ** | ブースト使用した次のターンはBP自然回復なし |

#### ブースト段階と効果

| ブーストLv | 消費BP | 効果 |
|-----------|--------|------|
| Lv.0 | 0 | 通常（1.0x） |
| Lv.1 | 1 | 2倍の効果/攻撃回数 |
| Lv.2 | 2 | 3倍の効果/攻撃回数 |
| Lv.3（MAX） | 3 | 4倍の効果/攻撃回数 |

#### コマンド別ブースト効果

| コマンド種類 | ブースト効果 |
|-------------|-------------|
| **たたかう** | 攻撃**回数**が増加（MAX時4回攻撃、シールド削りに最適） |
| **アビリティ** | ダメージ**倍率**が上昇（回数は増えない） |
| **回復スキル** | 回復量が増加 |
| **バフ・デバフ** | **効果時間**が延長（Lv × 2ターン追加） |
| **確率スキル** | 成功確率が上昇 |

#### 戦略的運用

- **ブレイク時に集中消費**: 敵防御が下がっているため大ダメージ
- **BP5でオーバーフロー回避**: 溢れる前に消費
- **BPパサー（譲渡）**: BP供給役→アタッカーの連携でペナルティ回避

> **設計意図**: BPは「今は貯める」か「今は使う」の二択を迫るリソースマネジメント要素

### 3.6.6 敵データ構造

```typescript
interface BreakableEnemy {
    id: string;
    name: string;
    
    // 基本ステータス
    hp: number;
    maxHp: number;
    attack: number;
    defense: number;
    
    // ブレイクシステム
    shield: number;              // 現在のシールドポイント
    maxShield: number;           // 最大シールドポイント
    weaknesses: WeaknessType[];  // 弱点リスト（順番固定）
    revealedWeaknesses: boolean[]; // 発見済みフラグ
    isBroken: boolean;           // ブレイク状態かどうか
    breakStartTurn: number;      // ブレイクしたターン数（回復判定用）
    
    // ドロップ
    expReward: number;
    goldReward: number;
    drops: ItemDrop[];
}

type WeaknessType = 
    | 'sword' | 'spear' | 'dagger' | 'axe' | 'bow' | 'staff'
    | 'fire' | 'ice' | 'lightning' | 'wind' | 'light' | 'dark';
```

### 3.6.7 弱点の表示順序（固定）

```
剣 > 槍 > 短剣 > 斧 > 弓 > 杖 > 本 > 扇 > 火 > 氷 > 雷 > 風 > 光 > 闇
```

> 敵の弱点はこの順序で表示され、未発見は「?」マーク

### 3.6.8 バトルUI（ブレイクシステム対応）

```
┌─────────────────────────────────────────────────────────────┐
│ TURN: 3  ← ターンカウンター（左上）                         │
│                                                             │
│                        バトル背景                           │
│    [敵スプライト]                                           │
│    ゴブリン                                                 │
│    ●●●●● (5)  ← シールドポイント                          │
│    [剣][?][?][火][?] ← 弱点（発見済み/未発見）              │
│    （ブレイク時は頭上に★が回る）                             │
│                                                             │
│                                [パーティ4人]                │
│                                [剣]とりくん  HP: 100        │
│                                [斧]だいちゃん HP: 80         │
│                                [弓]しんいち  HP: 90         │
│                                [杖]たいさ    HP: 120        │
└─────────────────────────────────────────────────────────────┘
├─────────────────────────────────────────────────────────────┤
│ ┌──────────┐ ┌─────────────────────────────────────────────┐│
│ │ 敵名     │ │ キャラ名    HP     ATBゲージ               ││
│ ├──────────┤ │ とりくん    100    ████████████████████░░░ ││
│ │▶たたかう │ │ だいちゃん   80    ██████████████░░░░░░░░░ ││
│ │ とくぎ   │ │ しんいち    90    █████████░░░░░░░░░░░░░░ ││
│ │ にげる   │ │ たいさ     120    ███████░░░░░░░░░░░░░░░░ ││
│ └──────────┘ └─────────────────────────────────────────────┘│
└─────────────────────────────────────────────────────────────┘
```

### 3.6.9 戦闘フロー（ブレイク込み）

```mermaid
graph TD
    A[プレイヤーターン] --> B{弱点攻撃?}
    B -->|Yes| C[シールド-1, ダメージ1.3x]
    B -->|No| D[通常ダメージ]
    C --> E{シールド=0?}
    E -->|Yes| F[ブレイク発動!]
    E -->|No| G[敵ターン]
    F --> H[敵スタン＆ダメージ2倍]
    H --> I[プレイヤー追撃チャンス]
    I --> J[ブレイク解除, シールド回復]
    J --> G
    D --> G
```

### 3.6.10 MVP実装範囲

| 機能 | MVP対応 | 備考 |
|------|---------|------|
| シールドポイント表示 | ✅ | 敵の下に数字で表示 |
| 弱点表示 | ✅ | アイコンで表示（発見済み/未発見） |
| 弱点攻撃でシールド削減 | ✅ | 1ヒット=1削減 |
| 弱点ダメージボーナス | ✅ | 1.3倍 |
| ブレイク状態 | ✅ | スタン＆ダメージ2倍 |
| ブレイク時演出 | ✅ | シールド破壊エフェクト |
| BP（ブーストポイント） | ⬜ | 将来実装 |
| マルチヒット攻撃 | ⬜ | 将来実装 |
| 分析スキル | ⬜ | 将来実装 |

### 3.6.11 実装上の注意点

1. **弱点判定**: 攻撃属性と敵の弱点リストを照合
2. **シールド表示更新**: シールド削減時にアニメーション付きで更新
3. **ブレイク状態管理**: `isBroken`フラグと`breakRecoveryTurn`で制御
4. **ダメージ計算順序**: 弱点ボーナス → ブレイクボーナス（ブレイク中は弱点ボーナス無効）
5. **UI更新**: シールドと弱点の表示は敵スプライトの下に固定配置

---

## 4. UI設計

### 4.1 解像度とスケーリング

| 設定 | 値 |
|------|-----|
| ゲーム内部解像度 | 480 x 320 |
| スケーリング | FIT (アスペクト比維持) |
| ピクセルパーフェクト | 有効 |
| タイルサイズ | 16 x 16 |

### 4.2 スプライト仕様（FF6/FFRK風）

> 参考: https://dotartplay.com/ff-dot-new

#### キャラクタースプライト

| 項目 | 値 | 備考 |
|------|-----|------|
| **サイズ** | 16 x 24 | FF6/FFRK標準 |
| **頭の高さ** | 約13px | プロポーション比率 |
| **体の高さ** | 約5px | |
| **足の高さ** | 約5-6px | |
| **色数** | 8-16色/キャラ | パレット制限 |

#### 色調ガイドライン

- **液晶対応**: SFC版より明るめの色を使用
- **ハイライト**: 光源を意識した明暗表現
- **アウトライン**: 暗めの色で輪郭を強調

#### 敵スプライト

| 敵タイプ | サイズ | 備考 |
|----------|--------|------|
| 小型（スライム等） | 24 x 24 〜 32 x 32 | |
| 中型（ゴブリン等） | 32 x 32 〜 48 x 48 | |
| 大型（ボス等） | 64 x 64 〜 96 x 96 | v0.3以降 |


### 4.2 画面一覧

| 画面ID | 画面名 | 説明 |
|--------|--------|------|
| S-001 | TitleScene | タイトル画面 |
| S-002 | MapScene | フィールド移動 |
| S-003 | BattleScene | バトル画面 |
| S-004 | MenuScene | メニュー画面 (v0.2) |

### 4.3 カラーパレット

```css
/* メインカラー */
--color-primary: #e94560;    /* 赤（アクセント） */
--color-secondary: #4ade80;  /* 緑（プレイヤー） */
--color-accent: #fbbf24;     /* 金（ハイライト） */

/* 背景 */
--color-bg-dark: #1a1a2e;
--color-bg-mid: #16213e;
--color-bg-light: #0f3460;

/* テキスト */
--color-text: #ffffff;
--color-text-muted: #a0a0a0;
```

### 4.4 フォント
- **UI/メニュー**: Press Start 2P (Google Fonts)
- **本文**: システムフォント (fallback)

---

## 5. バトルシステム設計

### 5.1 ダメージ計算式

#### 現在のMVP実装（簡易版）

```
基本ダメージ = 攻撃力 - 防御力 / 2
最終ダメージ = max(1, 基本ダメージ * 乱数(0.9~1.1))

ぼうぎょ時: 最終ダメージ = 最終ダメージ / 2
ブレイク時: 最終ダメージ = 最終ダメージ * 1.5
```

#### 将来実装用：オクトパストラベラー風計算式（参考）

> 参考: `docs/オクトパストラベラー戦闘メカニクス詳細解析.md`

```typescript
// 基本ダメージ計算
Damage = (Attack × LevelMod - Defense × 0.5) × AbilityPower × Multipliers × RNG

// LevelMod: レベルスケーリング係数（Lv1=0.45, Lv70=1.0程度）
// AbilityPower: 技ごとの固有倍率（たたかう=1.0, 強攻撃=1.5等）
// RNG: 乱数幅 0.98～1.02（±2%、再現性重視）
```

#### 乗算マルチプライヤー一覧

全ての補正が**乗算**で適用される。これがダメージインフレの正体。

| 補正要素 | 倍率 | 条件・備考 |
|---------|------|----------|
| クリティカル | × 1.25 | クリティカル発生時 |
| 弱点 | × 1.30 | ブレイクしていない状態で弱点を突いた場合 |
| **ブレイク** | × 2.00 | ブレイク中の敵への攻撃（弱点補正は適用されず2.0x優先） |
| ブースト | × 1.0～4.0 | BP消費量に応じた補正 |
| バフ（攻撃UP） | × 1.50 | 味方の攻撃力上昇状態 |
| デバフ（防御DOWN） | × 1.50 | 敵の防御力低下状態 |

#### 理論最大倍率

```
Total = 2.0(Break) × 4.0(Boost) × 1.5(Buff) × 1.5(Debuff) × 1.25(Crit) = 22.5x
```

奥義（倍率10x）と組み合わせれば、通常攻撃の**200倍以上**のダメージが可能。
これが「準備（Setup）」→「実行（Execution）」というバトルの醍醐味を生む。

### 5.2 シールド/ブレイクシステム (v0.2)

```
シールドポイント (SP): 敵ごとに設定
弱点攻撃時: SP -= 1
SP == 0: ブレイク状態

ブレイク状態:
- 1ターン行動不能
- 被ダメージ 1.5倍
- ターン終了後 SP 全回復
```

### 5.3 コマンド一覧

| コマンド | 説明 | MVP |
|---------|------|-----|
| たたかう | 通常攻撃 | ✅ |
| ぼうぎょ | 被ダメージ半減 | ✅ |
| にげる | 50%で逃走成功 | ✅ |
| アビリティ | キャラクター固有スキル | ✅ |
| アイテム | アイテム使用 | ✅ |

### 5.4 アビリティ仕様 (MVP)

各キャラクターは固有のアビリティ（コマンド）を持つ。MPを消費して強力な効果を発揮する。

| キャラ | コマンド | 消費MP | 対象 | 効果 | 備考 |
|--------|---------|--------|------|------|------|
| **とりくん** | ぜんりょく | 5 | 敵単体 | 威力 1.5倍物理攻撃 | シンプルな強攻撃 |
| **だいちゃん** | たたきわる | 6 | 敵単体 | 威力 1.2倍 + **シールド2削減** | ブレイク狙いに有効 |
| **しんいち** | ねらう | 4 | 敵単体 | **必中クリティカル**攻撃 | 回避が高い敵に有効 |
| **たいさ** | いのる | 8 | 味方全体 | HP 30回復 | 全体回復手段 |

### 5.5 アイテム仕様 (MVP)

所持品はパーティ共有。MVPでは個数制限なし（無限）または固定数所持で実装。

| アイテム名 | 対象 | 効果 |
|------------|------|------|
| **ポーション** | 味方単体 | HP 50 回復 |
| **ハイポーション** | 味方単体 | HP 200 回復 |
| **エーテル** | 味方単体 | MP 20 回復 |

### 5.6 レベルアップシステム (MVP)

#### 5.6.1 経験値システム

| 項目 | 仕様 |
|------|------|
| 経験値獲得タイミング | バトル勝利時 |
| 経験値分配 | 生存パーティメンバー全員に同量付与 |
| 戦闘不能メンバー | 経験値を獲得しない |

#### 5.6.2 敵の経験値報酬

| 敵名 | 経験値 |
|------|--------|
| スライム | 15 |
| コウモリ | 12 |
| ゴブリン | 25 |

#### 5.6.3 必要経験値テーブル

レベルアップに必要な累計経験値はFF6風の計算式を使用。

```typescript
// 必要経験値計算式（累計）
// FF6簡略版: 次のレベルに必要な経験値が徐々に増加
function getRequiredExpForLevel(level: number): number {
    if (level <= 1) return 0;
    // レベル2に必要: 32, レベル3: 96, ...
    return Math.floor(16 * (level - 1) ** 2);
}
```

| レベル | 必要累計EXP | 差分 |
|--------|-------------|------|
| 1 | 0 | - |
| 2 | 16 | 16 |
| 3 | 64 | 48 |
| 4 | 144 | 80 |
| 5 | 256 | 112 |
| 6 | 400 | 144 |
| 7 | 576 | 176 |
| 8 | 784 | 208 |
| 9 | 1024 | 240 |
| 10 | 1296 | 272 |

#### 5.6.4 ステータス成長

レベルアップ時に各ステータスが上昇。キャラクターごとに成長率が異なる。

```typescript
interface GrowthRates {
    hp: number;    // HP上昇量
    mp: number;    // MP上昇量
    attack: number;   // 攻撃力上昇量
    defense: number;  // 防御力上昇量
    speed: number;    // 素早さ上昇量
}
```

| キャラ | HP | MP | 攻撃 | 防御 | 素早さ | 特徴 |
|--------|-----|-----|------|------|--------|------|
| とりくん | +12 | +3 | +2 | +1 | +2 | バランス型 |
| だいちゃん | +10 | +2 | +3 | +1 | +3 | アタッカー型 |
| しんいち | +11 | +3 | +2 | +2 | +1 | 技巧型 |
| たいさ | +14 | +5 | +2 | +1 | +1 | 回復型 |

#### 5.6.5 レベルアップ処理フロー

```
[バトル勝利]
    ↓
[敵の経験値を獲得表示]
    ↓
[生存メンバーに経験値加算]
    ↓
[レベルアップ判定]
    ↓ (レベルアップした場合)
[レベルアップ演出]
    ↓
[ステータス上昇表示]
    ↓
[HP/MP全回復（レベルアップボーナス）]
    ↓
[バトル終了]
```

#### 5.6.6 勝利演出仕様

1. **経験値獲得メッセージ**: `「○○をたおした！\n△△けいけんちをかくとく！」`
2. **レベルアップ時**: 各キャラにつき以下を表示
   - `「○○はレベル△になった！」`
   - ステータス上昇詳細（省略版: HPとMPのみ表示）
3. **ファンファーレ**: 将来的にBGM対応時に追加

#### 5.6.7 MVP実装範囲

| 機能 | MVP対応 | 備考 |
|------|---------|------|
| 経験値獲得 | ✅ | 勝利時に自動付与 |
| レベルアップ判定 | ✅ | 必要経験値に達したら上昇 |
| ステータス上昇 | ✅ | HP/MP/攻撃/防御/素早さ全て |
| 演出表示 | ✅ | テキストで成長を表示 |
| 最大HP/MP回復 | ✅ | レベルアップ時に全回復 |
| レベル上限 | ⬜ | 将来実装（99予定） |
| 経験値2倍アイテム | ⬜ | 将来実装 |

---

## 6. 入力設計

### 6.1 マップ画面

| 入力 | アクション |
|------|----------|
| WASD / 矢印キー | 移動 |
| ESC | タイトルに戻る |
| B | バトル画面へ（デバッグ） |

### 6.2 バトル画面

| 入力 | アクション |
|------|----------|
| W / ↑ | コマンド上移動 |
| S / ↓ | コマンド下移動 |
| SPACE / ENTER / Z | 決定 |
| ESC / X | キャンセル / 戻る |

---

*このドキュメントは技術的な設計判断の記録として使用されます。*
